--- WeakAura Strings ---
daf6zaGiK4ssrztqkfnkPiNseAvqkfEfKsvZcu5wqQAxaYVGuk1Wqv6yqvwgqLNHKQPHKY1qv02GuY3qvyCsjohuP6DGQMhuP09es7dQu4FqLIoiOSqGIEiqPjkeUiGQncO8rrXirs6KqkwPOAMcrUPiyNsj9tKegQOKLcu1tfPPIQ6QqfTviLkFfQQ3cvYCHuk5UqQSxi(lIgS6WOYIfKhlLAYcCzjBgGplfgnqoniVwiknBH62qYULQFJudhOWYHYZry6OCDb12fL67crX4rs05frRxkQ8EPOQ5dv4(cr1(PrWdHpskkK0aK0ae(iPaO7SuOMRqAfCudjLkPcaaikgsRON68GNiPbqeGrmxs(fvYqsBwBZrsBhMGrJIFrLmKuaH7Tzq09Ms0C3DhFyKWkgOKeKzOXkaqvpGe8flmwpLHb1B4rDkU7U7U7U7U7U7U7U7U7U7U7U7U7U7U7U7U7U7U7U7U7uG3C3D3C3DhanMhzHlBhQ7Gbhegrt4dJewXaLKGmdnwbaQ6bKzfZLSW4ZfkUs0dOn3D3D3DiaE24cCOZfhr9ouSZavDZD3D3D3D3JPBZf7DouLh1Zgx4Ho4n3D3D3D3DpMUnxSZGqvyEuNGHb1BaeaAmuCSMO0mGWdaf48SXf4qNJEptX4dHQAkXeH3C3D3D3D39y62CXodcvHbw6yAmpQtHc8M7U7U7U7Uht3Ml2rrhIQfxmdKh1XJx8G3C3D3D3D3Diao(WiHvmqjjiZqJvaGQEazc0H4ZfkUWv24I6OdDU4iQ3HIDgOQ7OOdr1IlMbYJ64dJewXaLKGmdnwbaQ6bKjqhIpxO4cxzJlQJo0H2gFyKWkgOKeKzOXkaqvpGeSPjWrLunl0g4XlVW7vpWC3D3D3D3DZD3D3D3D3rp6D(qOkmhTP3khQYblDmnM5U7U7U7U7qaCgDpmQqfwtmiufwIoUruhpEDgOQBU7U7U7U7U7UZGqvyGLoMgZJ6uWrBGbmGdMGdT4fgfhiGCgeQcZbciNcoWOaV5U7U7U7U7U7ENdv5rDk4OnWagWbtWHw8cJIdeqENdv5abKtbhyuG3C3D3D3D39kMOm3D3D3D3D3D3zqOkmWshtJ5rDk4OnWag14reGL6TqXbciNbHQWCGaYPGdmkWBU7U7U7U7U7U35qvEuNcoAdmGrnEebyPEluCGaY7COkhiGCk4aJc8M7U7U7U7Ux9aZD3D3D3D3rp6DQwCXmqEwfw7QZ4AuoyPJPXm3D3D3D3DhcGJIoevlUygipAuhpEXZzGQU5U7U7U7U7U7oOIlMbkRcRD1zCnkpQtb3e3Kc8M7U7U7U7UxXefeahfDiQwCXmqoUnQtDE6mqv3C3D3D3D3D3DhuXfZaLvH1U6mUgLh1jyyq9gabGgdfhRjk4OnWagWbtWHw8cRzaXlaCGrbohfDiQwCXmqjcV5U7U7U7U7vmrbbWrrhIQfxmdKJBJ68GxNbQ6M7U7U7U7U7U7GkUygOSkS2vNX1O8OobddQ3aia0yO4ynrbhTbgWagW4re8cRzaXlaCGrbohfDiQwCXmqjcV5U7U7U7U7vmrzU7U7U7U7U7UdQ4IzGYQWAxDgxJYJ6emmOEdGaqJHIJ1efC0gyaJA8icWs9wAgq8cahyuGZrrhIQfxmduIWBU7U7U7U7E1dm3D3D3D3D3C3D3D3D3D8HrcRyGssqMHgRaav9asWxSWy9ugguVHh1XhgjSIbkjbzgAScau1dibFXcJ1tzyq9goqa5uqBHh4OwNcqa5emmOEdGaqJHIJ1eLMr0uZis0rV3mckW5DoufCoOIlMbkRcRD1zCnk4CgeQcdS0X0yjcV5U7U7Ux9aZD39QhyU7UBU7UJvSWyDhFyKWkgOKeKzOXkaqvpGe8flmwpLHb1BaV5vpajnjvaaarXqALN8Ylskw1aIUZpjyuiPSIkziPqDigzBAuGrCXQaKwXdjLRndIUtGWhjfQdXq4JKgqt2ombJgfcyIK2ombJgfsk6rVJMoedIlgQ54yq0DZXhgjSIbkjbzgAScau1dibBAcCujvZYJ64Xl14bETWl8MJpmsyfduscYm0yfaOQhqMvmxYcJpxO4YJ6nFKdV54dJewXaLKGmdnwbaQ6bKjqhIpxO4YJ6nFKdV54dJewXaLKGmdnwbaQ6bKGNdkiHIGGRr5rDgw4cEZXhgjSIbkjbzgAScau1dibphuqcfbbxJIpeQcZJ6uhEZXhgjSIbkjbzgAScau1dibFXcJ1tzyq9gEuNcf4ryiPaG6qeGq4JK2ombJgfsQ5MJKgqtIQii4AuiHqsdOjBhMGrJcjecdHHKsuXaYIgQZqs5tfzHKcfGKIpmsyfduscYm0yfaOQhGKgUZWGA0OWq4JK2ombJgfsQ5MJWqsJmqbmqiaJhTGhV4o4WDEcoCh35rlT0cViaqp1OgskddQrJcdHpskljyuiPTdtWOrHKgUxzxDgskxygnsAyIImChIHaMiPbHX4yq0DKuQZtK0k7QZqsblioMNqrqW1OqsRSRoJajf4TcwQaNTYh4GNe4TgbCoyPIeaty8jJevKHe4ODaVv(K4SvGHMiXh4Gh4rGK2ombJgfskGW92mi6U3ejCojCor4qv2vNbNtcNtcNtcNtcNtcNhueSm4enraNhueSw5qvW5KW5bfbd8CqbalMRbbCobyuXXqbW5KW5KW5COOd3zjAU7Uht3Ml27COkpQhueSw5qvoxpWjyyq9ga1GiCOMckcwRCOk4Cknd94YihhOdTNcCofkj60yEhkgEZD3Diaor4qv2vN5mqv3C3D3D3Ha4bfbldorteoxpWjyyq9gabaQh0uqrWYGt0ebCof0J7uhCT0c6PKOZavDZD3D3D3D3Ha4emmOEdGaa1dAIiCOk7QZGZPqgbSeGLb4us0zGQU5U7U7U7U7U7oeaVtZC8HrcRyGssqMHgRaav9aYeOdXNluCHRGIGLbNOjc05mqv3C3D3D3D3D3D3D3XhgjSIbkjbzgAScau1ditGoeFUqXfUckcwgCIMiqNh1XhgjSIbkjbzgAScau1dibBAcCujvZcEZD3D3D3D3D39kMOm3D3D3D3D3D3D39y62CXovZks0eeEuNdfD4oZPXCEH3C3D3D3D3D3D3D3XhgjSIbkjbzgAScau1ditGoeFUqXfUckcwgCIMiqNh1XhgjSIbkjbzgAScau1ditGoeFUqXfUckcwgCIMiqNJENQzfjAcc4n3D3D3D3D3D3D3Diao(WiHvmqjjiZqJvaGQEazc0H4ZfkUWvqrWYGt0eb6CCRZRZavDZD3D3D3D3D3D3D3D3XhgjSIbkjbzgAScau1ditGoeFUqXfUckcwgCIMiqNh15fEZD3D3D3D3D3D3DV6bM7U7U7U7U7U7vpWC3D3D3D39QhyU7U7U7U7oeaNiCOk7QZ8OrDk4Sv0WNmc0a8iO4mqv3C3D3D3D3D3DhFyKWkgOKeKzOXkaqvpGmb6q85cfx4kOiyzWjAIaDEuVdfdV5U7U7U7U7vpWC3D3D3REG5U7U7UdbWjaJkogkW56bobyuXXqbE0OoETG74rD8CgOQBU7U7U7U7oeaNiCOk7QZ8OrDkPzb8ifjsy4e8WiHLvwrcnapckodu1n3D3D3D3D3D3zCHIlGG6efgRj8HrcRyGssqMHgRaav9aYSI5swy85cfxW5nFNdvbNNPy8HqvnLiAp15jCEqrWYGt0erKNi8M7U7U7U7U7U7yflmw3zyHl4n3D3D3D3DV6bM7U7U7U7UdbWjchQYU6mpAuNsAwapsrIegobpmsWd8eOc0oGhbfNbQ6M7U7U7U7U7U7aOX8ilCz7qDhm4GWiAcFyKWkgOKeKzOXkaqvpGmRyUKfgFUqXvIEaT5U7U7U7U7U7U7UdbWZgx4HopAuVZHQCgOQBU7U7U7U7U7U7U7U7oeahFyKWkgOKeKzOXkaqvpGe8CqbjueeCnkNbQ6M7U7U7U7U7U7U7U7U7U7X0T5IDgeQclsfaMh1ZgxGdDo69mfJpeQQPeH3C3D3D3D3D3D3D3D3D3DhcGZGqvyrQaWCCdhFyKWkgOKeKzOXkaqvpGe8CqbjueeCnk(qOkmNbQ6M7U7U7U7U7U7U7U7U7U7U7EA1daliowcfbbxJQjcgguVbqaOXqXXAIsZi8yOqfwf4CmVzaHhackW5DoufCodcvHfPcalr4CkGhgAIGsIWBU7U7U7U7U7U7U7U7U7Ux9aZD3D3D3D3D3D3D3D3D3DiaodcvHfPcaZXToVaHNZavDZD3D3D3D3D3D3D3D3D3D3DpT6bGfehlHIGGRr1ebddQ3aia0yO4ynrPzeEauf4bHXG6n8iGAuemkW5DouvIW5uapm0ebLeH3C3D3D3D3D3D3D3D3D3DV6bM7U7U7U7U7U7U7U7Ux9aZD3D3D3D3D3D3D3D3zCHIlGWku0zxnHpmsyfduscYm0yfaOQhqMvmxYcJpxO4copYMi8M7U7U7U7U7U7U7E1dm3D3D3D3D3D3REG5U7U7U7U7vpWC3D3D3REG5U7U7UdbWjchQYU6mpAuNcWBfSuboBLpWbpjWBnckodu1n3D3D3D3DhFyKWkgOKeKzOXkaqvpGmRyUKfgFUqXLh1B(ihEZD3D3D3D3XhgjSIbkjbzgAScau1ditGoeFUqXLh1B(ihEZD3D3D3D3XhgjSIbkjbzgAScau1dibFXcJ1tzyq9gEuNcf4n3D3D39QhyU7Ux9aZREasA7WemAuKSKGrHKwzxDgsA7WemAuKGGckKugeQkaHHK2dJIpguJgfgbsR4HK2MoMgdHpsR4H0kVaH7GdpEIwTGwGJhuJN8I7TG0k1rawl82slTGxl4XtQboEYd0Ix8qaGEEsDegskOcQbigcWqlEWtEsn8axlOf4AbCTWtQrneaONA8ajnMMlaHpsAyIISxzxyiHqsBo6EHKs1kogaew5GfIXfuXiPvVnD4oRWGcqsXJhTqDK0Wefz1BthUZkmOaKqiPbqaaa1oCmljcFKucOEJ4cjfvsgiO2iPOchZGq4JKIkjdeuBeWeHHWqsX4Axi8rsrfoMbHWhHHWqszCXvNHWhjfv4ygecFegcdjnmrr2C09cbmrsXOJle(iPOchZGq4JWqyiPeqnxHWhjLaQ3iUqszrMQZsIKIkCmdcHpsklYuDwseWeHHWqyiPCbbqmi6oxmjddQrJcJaHpcdHHKsGKcoGWdiEbcp0cjnBKwXJAGdpegcc

--[[
Author : Aethys
Version : 1.2 (09.17.2015)
Readme :
	WeakAura to display each Soul timer + their HP.
]]--


--- Actions\On Init\Custom ---

-- Init
-- Initialization
WA_Aethys_Gorefiend_CSMaxHP = 1047180;
WA_Aethys_Gorefiend_PlayerTable = {};
WA_Aethys_Gorefiend_MobTable = {};
WA_Aethys_Gorefiend_RaidMessage = true;
WA_Aethys_Gorefiend_RaidMessageTimer = 3;
WA_Aethys_Gorefiend_ReturnString = "";


--- Trigger\Custom Trigger ---

-- Trigger [ENCOUNTER_END, COMBAT_LOG_EVENT_UNFILTERED]
function (_, _, subevent, _, _, _, _, _, destGUID, destName, _, destRaidFlags, spellid, _, _, amount)
    local name = destName and string.gsub(destName, "%-[^|]+", "") or nil;
    if subevent then
        if destGUID and string.find(destGUID, "-93288-") then
            if string.find(subevent, "_DAMAGE") then
                if not WA_Aethys_Gorefiend_MobTable[destGUID] then
                    WA_Aethys_Gorefiend_MobTable[destGUID] = WA_Aethys_Gorefiend_CSMaxHP;
                else
                    local HPLoss = amount or 0;
                    WA_Aethys_Gorefiend_MobTable[destGUID] = WA_Aethys_Gorefiend_MobTable[destGUID] - HPLoss;
                    if WA_Aethys_Gorefiend_MobTable[destGUID] < 0 then
                        WA_Aethys_Gorefiend_MobTable[destGUID] = 0;
                    end
                end
            end
            if subevent == "UNIT_DIED" then
                WA_Aethys_Gorefiend_MobTable[destGUID] = nil;
            end
        end
        if spellid and spellid == 189131 then
            if subevent == "SPELL_AURA_APPLIED" then
                table.insert(WA_Aethys_Gorefiend_PlayerTable, {name, GetTime()+35, destGUID});
                return true;
            end
            if subevent == "SPELL_AURA_REMOVED" then
                for k,v in pairs(WA_Aethys_Gorefiend_PlayerTable) do
                    if v[1] == name then
                        if WA_Aethys_Gorefiend_RaidMessage then
                            local timerLeft = v[2] - GetTime();
                            if timerLeft > WA_Aethys_Gorefiend_RaidMessageTimer then
                                SendChatMessage(string.format("%s libered at %.1fs", name, timerLeft), "RAID");
                            end
                            if timerLeft < 0.1 then
                                SendChatMessage(string.format("%s died during Digest", name), "RAID");
                            end
                        end
                        table.remove(WA_Aethys_Gorefiend_PlayerTable, k);
                    end
                end
            end
        end
        if subevent == "ENCOUNTER_END" then
            WA_Aethys_Gorefiend_PlayerTable = {};
            WA_Aethys_Gorefiend_MobTable = {};
            WA_Aethys_Gorefiend_ReturnString = "";
        end
    end
end


--- Display\Custom Function ---

-- Refresh [Every Frame]
function()
    WA_Aethys_Gorefiend_ReturnString = "                                                               ";
    
    for k,v in pairs(WA_Aethys_Gorefiend_PlayerTable) do
        if v[2] ~= nil then
            local name = v[1];
            local timer = string.format("%.1f", v[2] - GetTime());
            local timerColor = "";
            local mobHealth = 101;
            if WA_Aethys_Gorefiend_MobTable[v[3]] ~= nil then mobHealth = WA_Aethys_Gorefiend_MobTable[v[3]]/WA_Aethys_Gorefiend_CSMaxHP*100; end
            
            -- Timer & Name Color
            if tonumber(timer) >= 10 then
                timerColor = "|cFFEB260A" .. timer .. "|r";
                name = "|cFFEB260A" .. name .. "|r";
            else
                timerColor = "|cFF47DC38" .. timer .. "|r";
                name = "|cFF47DC38" .. name .. "|r";
            end
            -- Health Percentage Color
            if mobHealth == 101 then
                healthPercentage = "??";
            elseif mobHealth <= 35 then
                healthPercentage = string.format("|cFFEB260A%.0f|r", mobHealth);
            elseif mobHealth <= 70 then
                healthPercentage = string.format("|cFFFF7D0A%.0f|r", mobHealth);
            else
                healthPercentage = string.format("|cFF47DC38%.0f|r", mobHealth);
            end
            
            WA_Aethys_Gorefiend_ReturnString = WA_Aethys_Gorefiend_ReturnString .. "\124n".. string.format("%s(%s) - %s", name, healthPercentage, timerColor);
        end
    end
    
    return WA_Aethys_Gorefiend_ReturnString;
end
    local f = WeakAuras["regions"][aura_env.id]["region"]
    f:SetWidth(max(f:GetWidth(), f:GetHeight()))
    f:SetHeight(f:GetWidth())
    local scale = f:GetWidth()/100
    
    f.bg = f.bg or f:CreateTexture(nil, "BACKGROUND", nil, 0)
    f.bg:SetTexture("Interface\\AddOns\\WeakAuras\\Media\\Textures\\Circle_White_Border")
    f.bg:SetAllPoints(f)
    f.bg:SetVertexColor(.3, .3, .3, .7)
    
    f.player = f.player or  f:CreateTexture(nil, "BACKGROUND", nil, 4)
    f.player:SetTexture("Interface\\Addons\\WeakAuras\\PowerAurasMedia\\Auras\\Aura118")
    f.player:SetPoint("CENTER", f, "CENTER", 0, 0)
    f.player:SetWidth(10*scale)
    f.player:SetHeight(10*scale)
    
    if aura_env.fChaosDisplay then
        f.players = f.players or {}
        f.lines = f.lines or {}
        
        for i=1,20 do
            f.lines[i] = f.lines[i] or  f:CreateTexture(nil,"BACKGROUND", nil, 2)
            f.lines[i]:SetTexture("Interface\\AddOns\\WeakAuras\\Media\\Textures\\Square_White")
            f.lines[i]:SetVertexColor(0,1,0,1)
            f.lines[i]:Hide()        
            
            f.players[i] = f.players[i] or f:CreateTexture(nil, "BACKGROUND", nil, 3)
            f.players[i]:SetTexture("Interface\\AddOns\\WeakAuras\\Media\\Textures\\Circle_Smooth_Border")
            f.players[i]:SetWidth(4*scale)
            f.players[i]:SetHeight(4*scale)
            f.players[i]:Hide()
        end
    end
    
    if aura_env.sTormentDisplay then
        f.shackles = f.shackles or {}
        f.shackletext = f.shackletext or {}
        
        for i=1,3 do
            f.shackles[i] = f.shackles[i] or f:CreateTexture(nil, "BACKGROUND", nil, 2)
            f.shackles[i]:SetTexture("Interface\\AddOns\\WeakAuras\\Media\\Textures\\Circle_White")
            f.shackles[i]:SetVertexColor(0,0,0.7,.5)
            f.shackles[i]:Hide()
            
            f.shackletext[i] = f.shackletext[i] or  f:CreateFontString(nil, "BACKGROUND")
            f.shackletext[i]:SetFont("Fonts\\FRIZQT__.TTF", 6*scale, "OUTLINE")
            f.shackletext[i]:Hide()
        end
        
        f.shackleself = f.shackleself or f:CreateTexture(nil, "BACKGROUND", nil, 1)
        f.shackleself:SetTexture("Interface\\AddOns\\WeakAuras\\Media\\Textures\\Circle_White")
        f.shackleself:SetVertexColor(0,0,0.7,.5)
        f.shackleself:Hide()
    end
    
    local zoom = 1
    
    for i=1,20 do
        local ax, ay, bx, by, da, db
        local px, py = UnitPosition("player")
        
        if aura_env.fChaosDisplay and UnitDebuff("raid"..i, aura_env.fChaos) then
            local focused = gsub(UnitName("raid"..i), "%-[^|]+", "")
            local wrought = gsub(UnitName(select(8, UnitDebuff("raid"..i, aura_env.fChaos))), "%-[^|]+", "")
            
            if focused then
                ax, ay = UnitPosition(focused)
                da = ((px-ax)^2+(py-ay)^2)^(1/2)
                if da == 0 then zoom = zoom or 1 else zoom = min(2, 1/(da/50), zoom)  end
            end
            
            if wrought then
                bx, by = UnitPosition(wrought)
                db = ((px-bx)^2+(py-by)^2)^(1/2)
                if db == 0 then zoom = min(2, zoom) else zoom = min(2, zoom, 1/(db/50), zoom)  end
            end
        end
        
        if aura_env.sTormentDisplay and UnitDebuff("raid"..i, aura_env.sTorment) then
            local name =  gsub(UnitName("raid"..i), "%-[^|]+", "")
            if not aura_env.shackles[name] then
                print("WA Chaos Error (1): " .. name .. " has Shackles, but no Coords stored!")
            else
                local ax, ay = aura_env.shackles[name].x, aura_env.shackles[name].y
                local da = ((px-ax)^2+(py-ay)^2)^(1/2)  + 26
                if da == 0 then zoom = zoom or 1 else zoom = min(2, 1/(da/50), zoom)  end
            end
        end
    end
    
    local lineidx = 0
    
    if aura_env.fChaosDisplay then
        for i=1,20 do
            local ax, ay, bx, by, da, db
            local px, py = UnitPosition("player")
            
            if UnitDebuff("raid"..i, aura_env.fChaos) then
                lineidx = lineidx + 1
                
                local focused = gsub(UnitName("raid"..i), "%-[^|]+", "")
                local wrought = gsub(UnitName(select(8, UnitDebuff("raid"..i, aura_env.fChaos))), "%-[^|]+", "")
                
                if focused then
                    ax, ay = UnitPosition(focused)
                    da = ((px-ax)^2+(py-ay)^2)^(1/2)
                end
                
                if wrought then
                    bx, by = UnitPosition(wrought)
                    db = ((px-bx)^2+(py-by)^2)^(1/2)
                end
                
                --[[
                if focused then      
                    local colors = RAID_CLASS_COLORS[select(2, UnitClass(focused))]
                    f.sa:SetVertexColor(colors.r, colors.g, colors.b, 1)
                    local radian = math.atan2((py - ay), (px - ax)) - GetPlayerFacing()
                    local ox = scale * zoom * da * math.cos(radian)  
                    local oy = scale * zoom * da * math.sin(radian)  
                    f.sa:SetPoint("CENTER", f, "CENTER", oy, -ox)
                    f.sa:SetText(skull..focused)
                    f.sa:Show()
                else
                    f.sa:Hide()
                    f.line:Hide()
                end
                
                
                if wrought then
                    local colors = RAID_CLASS_COLORS[select(2, UnitClass(wrought))]
                    f.sb:SetVertexColor(colors.r, colors.g, colors.b, 1)
                    local radian = math.atan2((py - by), (px - bx)) - GetPlayerFacing()
                    local ox =  scale * zoom * db * math.cos(radian)  
                    local oy =  scale * zoom * db * math.sin(radian)  
                    f.sb:SetPoint("CENTER", f, "CENTER", oy, -ox)
                    f.sb:SetText(cross..wrought)
                    f.sb:Show()
                else
                    f.sb:Hide()
                    f.line:Hide()
                end
                ]]
                
                if focused and wrought and (ax~=bx or ay~=by) then
                    --extend line beyond focused
                    do
                        local x1 = (px-ax)*(zoom/2)
                        local x2 = (px-bx)*(zoom/2)
                        local y1 = (py-ay)*(zoom/2)
                        local y2 = (py-by)*(zoom/2)
                        local dx = x2-x1
                        local dy = y2-y1
                        local dr = math.sqrt(dx^2 + dy^2)
                        --local dr = max(80, math.sqrt(dx^2 + dy^2))
                        local D =  x1*y2 - x2*y1
                        
                        local t =  ((25)^2) * dr^2 - D^2
                        if t >= 0 then
                            local x1 = ( D*dy - dx*math.sqrt(t))/dr^2
                            local y1 = (-D*dx - dy*math.sqrt(t))/dr^2
                            ax= (px-(x1/(zoom/2)))
                            ay= (py-(y1/(zoom/2)))
                        end
                    end
                    
                    --color
                    local u = ((px-ax)*(bx-ax) + (py-ay)*(by-ay)) / ((bx-ax)^2 + (by-ay)^2)
                    local pdist = 10
                    
                    --[[if u < 0 then
                        cx = ax
                        cy = ay
                    end
                    if u > 1 then
                        cx = bx
                        cy = by
                    end--]] 
                    
                    if u <= 1  then
                        local cx = ax + u*(bx-ax)
                        local cy = ay + u*(by-ay) 
                        pdist = sqrt((px-cx)^2+(py-cy)^2)
                    end
                    
                    if focused == gsub(UnitName("player"), "%-[^|]+", "") or wrought == gsub(UnitName("player"), "%-[^|]+", "") then
                        f.lines[lineidx]:SetVertexColor(0,1,1,1)
                    elseif (pdist < 2.1  or (da == 0 and u == 1/0))  then
                        f.lines[lineidx]:SetVertexColor(1,0,0,1)
                        f.bg:SetVertexColor(.5, .3, .3, .7)
                        if GetTime()  > (aura_env.lastWarn or 0) + 1 then
                            aura_env.lastWarn = GetTime() 
                            PlaySoundFile(WeakAuras.PowerAurasSoundPath.."sonar.ogg", "master")
                        end
                        --[[
                        if not aura_env.warned then
                            PlaySoundFile(WeakAuras.PowerAurasSoundPath.."sonar.ogg", "master")
                            aura_env.warned = true
                        end
                        ]]
                        --else
                        --    f.lines[i]:SetVertexColor(0,1,0,1)
                        --aura_env.warned = nil
                    end
                    
                    --f.height = f.height or {}
                    --f.width = f.width or {}
                    
                    local height = scale * zoom * 3
                    local width =  scale * zoom * ((ax-bx)^2 + (ay-by)^2)^(0.5)
                    
                    if width == 0 then
                        f.lines[lineidx]:Hide()
                    else            
                        --translate
                        local mx, my = (ax+bx)/2, (ay+by)/2
                        local radian = math.atan2((py - my), (px - mx)) - GetPlayerFacing()
                        local dm = ((px-mx)^2+(py-my)^2)^(1/2)
                        local ox =  scale * zoom * dm * math.cos(radian)  
                        local oy =  scale * zoom * dm * math.sin(radian)  
                        f.lines[lineidx]:SetPoint("CENTER", f, "CENTER", oy, -ox)
                        
                        --rotation angle
                        local radian = math.atan2((ax - bx), (ay - by)) + GetPlayerFacing()
                        radian = radian % (2 * math.pi)
                        local angle = radian % (math.pi / 2)
                        
                        local left, top, right, bottom = 0, 0, 1, 1
                        
                        local dy = width * math.cos(angle) * math.sin(angle) * (bottom-top) / height
                        local dx = height * math.cos(angle) * math.sin(angle) * (right - left) / width
                        local ox = math.cos(angle) * math.cos(angle) * (right-left)
                        local oy = math.cos(angle) * math.cos(angle) * (bottom-top)
                        
                        local newWidth = width*math.cos(angle) + height*math.sin(angle)
                        local newHeight = width*math.sin(angle) + height*math.cos(angle)
                        
                        local ULx, ULy, LLx, LLy, URx, URy, LRx, LRy
                        
                        if radian < math.pi / 2 then -- 0 ~ 90
                            ULx = left - dx     ULy = bottom - oy
                            LLx = right - ox    LLy = bottom + dy
                            URx = left + ox     URy = top - dy
                            LRx = right + dx    LRy = top + oy
                        elseif radian < math.pi then -- 90 ~ 180
                            URx = left - dx     URy = bottom - oy
                            ULx = right - ox    ULy = bottom + dy
                            LRx = left + ox     LRy = top - dy
                            LLx = right + dx    LLy = top + oy
                            newHeight, newWidth = newWidth, newHeight
                        elseif radian < 3 * math.pi / 2 then -- 180 ~ 270
                            LRx = left - dx     LRy = bottom - oy
                            URx = right - ox    URy = bottom + dy
                            LLx = left + ox     LLy = top - dy
                            ULx = right + dx    ULy = top + oy
                        else -- 270 ~ 360                
                            LLx = left - dx     LLy = bottom - oy
                            LRx = right - ox    LRy = bottom + dy
                            ULx = left + ox     ULy = top - dy
                            URx = right + dx    URy = top + oy
                            newHeight, newWidth = newWidth, newHeight
                        end
                        
                        f.lines[lineidx]:SetTexCoord(ULx, ULy, LLx, LLy, URx, URy, LRx, LRy)
                        f.lines[lineidx]:SetWidth(newWidth)
                        f.lines[lineidx]:SetHeight(newHeight)
                        f.lines[lineidx]:Show()
                    end
                end
            end
        end
    end
    
    
    local i = 0    
    local px, py = UnitPosition("player")
    
    for j = 1,20 do
        if aura_env.fChaosDisplay and UnitExists("raid"..j) and not UnitIsDead("raid"..j) and gsub(UnitName("raid"..j), "%-[^|]+", "") ~= gsub(UnitName("player"), "%-[^|]+", "") then
            
            local ax, ay = UnitPosition("raid"..j)
            local da = ((px-ax)^2+(py-ay)^2)^(1/2)
            
            if da <  48 / zoom then
                local radian = math.atan2((py - ay), (px - ax)) - GetPlayerFacing()
                local ox = scale * zoom * da * math.cos(radian)  
                local oy = scale * zoom * da * math.sin(radian)  
                local colors = RAID_CLASS_COLORS[select(2, UnitClass("raid"..j))]
                
                f.players[j]:SetPoint("CENTER", f, "CENTER", oy, -ox)
                f.players[j]:SetVertexColor(colors.r, colors.g, colors.b, 1)
                f.players[j]:Show()
            end
        end
        
        if aura_env.sTormentDisplay and UnitExists("raid"..j) and UnitDebuff("raid"..j, aura_env.sTorment) then
            i = i + 1
            local name = gsub(UnitName("raid"..j), "%-[^|]+", "")
            
            
            if not aura_env.shackles[name] then
                print("WA Chaos Error (2): " .. name .. " has Shackles, but no Coords stored!")
            else
                local ax, ay = aura_env.shackles[name].x, aura_env.shackles[name].y
                
                local da = ((px-ax)^2+(py-ay)^2)^(1/2)
                local radian = math.atan2((py - ay), (px - ax)) - GetPlayerFacing()
                local ox = scale * zoom * da * math.cos(radian)  
                local oy = scale * zoom * da * math.sin(radian)  
                f.shackles[i]:SetPoint("CENTER", f, "CENTER", oy, -ox)
                f.shackletext[i]:SetPoint("CENTER", f, "CENTER", oy, -ox)
                
                f.shackles[i]:SetWidth(51*scale*zoom)
                f.shackles[i]:SetHeight(51*scale*zoom)
                
                f.shackletext[i]:SetVertexColor(1,1,1,.7)
                if name == gsub(UnitName("player"), "%-[^|]+", "") then
                    f.shackles[i]:SetVertexColor(0,0,.7,.5)
                    f.shackletext[i]:SetVertexColor(1,0,0,1)
                    f.shackleself:SetVertexColor(.7, 0, .7, .5)
                    f.shackleself:SetPoint("CENTER", f, "CENTER", oy, -ox)
                    
                    f.shackleself:SetWidth(61*scale*zoom)
                    f.shackleself:SetHeight(61*scale*zoom)
                    f.shackleself:Show()
                elseif da < 25.5  then
                    f.shackles[i]:SetVertexColor(.7,0,0,.5)
                else
                    f.shackles[i]:SetVertexColor(0,0.7,0,.5)
                end
                
                local count = 0
                local count2 = 0
                for k=1, 20 do
                    local x, y = UnitPosition("raid"..k)
                    if not UnitIsDead("raid"..k) and ((x-ax)^2 + (y-ay)^2)^(1/2) < 25.5 then
                        if UnitDebuff("raid"..k, aura_env.sTorment) then
                            count2 = count2 + 1
                        else            
                            count = count + 1
                        end
                    end
                end
                
                --f.shackletext[i]:SetText(count .. "/" .. count2)
                f.shackletext[i]:SetText(count)
                f.shackletext[i]:Show()
                f.shackles[i]:Show()
            end
        end
        
    end
    
    return ""
end