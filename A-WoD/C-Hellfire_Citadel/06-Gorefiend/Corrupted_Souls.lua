--- WeakAura Strings ---
daf6zaGiK4ssrztqkfnkPiNseAvqkfEfKsvZcu5wqQAxaYVGuk1Wqv6yqvwgqLNHKQPHKY1qv02GuY3qvyCsjohuP6DGQMhuP09es7dQu4FqLIoiOSqGIEiqPjkeUiGQncO8rrXirs6KqkwPOAMcrUPiyNsj9tKegQOKLcu1tfPPIQ6QqfTviLkFfQQ3cvYCHuk5UqQSxi(lIgS6WOYIfKhlLAYcCzjBgGplfgnqoniVwiknBH62qYULQFJudhOWYHYZry6OCDb12fL67crX4rs05frRxkQ8EPOQ5dv4(cr1(PrWdHpskkK0aK0ae(iPaO7SuOMRqAfCudjLkPcaaikgsRON68GNiPbqeGrmxs(fvYqsBwBZrsBhMGrJIFrLmKuaH7Tzq09Ms0C3DhFyKWkgOKeKzOXkaqvpGe8flmwpLHb1B4rDkU7U7U7U7U7U7U7U7U7U7U7U7U7U7U7U7U7U7U7U7U7uG3C3D3C3DhanMhzHlBhQ7Gbhegrt4dJewXaLKGmdnwbaQ6bKzfZLSW4ZfkUs0dOn3D3D3DiaE24cCOZfhr9ouSZavDZD3D3D3D3JPBZf7DouLh1Zgx4Ho4n3D3D3D3DpMUnxSZGqvyEuNGHb1BaeaAmuCSMO0mGWdaf48SXf4qNJEptX4dHQAkXeH3C3D3D3D39y62CXodcvHbw6yAmpQtHc8M7U7U7U7Uht3Ml2rrhIQfxmdKh1XJx8G3C3D3D3D3Diao(WiHvmqjjiZqJvaGQEazc0H4ZfkUWv24I6OdDU4iQ3HIDgOQ7OOdr1IlMbYJ64dJewXaLKGmdnwbaQ6bKjqhIpxO4cxzJlQJo0H2gFyKWkgOKeKzOXkaqvpGeSPjWrLunl0g4XlVW7vpWC3D3D3D3DZD3D3D3D3rp6D(qOkmhTP3khQYblDmnM5U7U7U7U7qaCgDpmQqfwtmiufwIoUruhpEDgOQBU7U7U7U7U7UZGqvyGLoMgZJ6uWrBGbmGdMGdT4fgfhiGCgeQcZbciNcoWOaV5U7U7U7U7U7ENdv5rDk4OnWagWbtWHw8cJIdeqENdv5abKtbhyuG3C3D3D3D39kMOm3D3D3D3D3D3zqOkmWshtJ5rDk4OnWag14reGL6TqXbciNbHQWCGaYPGdmkWBU7U7U7U7U7U35qvEuNcoAdmGrnEebyPEluCGaY7COkhiGCk4aJc8M7U7U7U7Ux9aZD3D3D3D3rp6DQwCXmqEwfw7QZ4AuoyPJPXm3D3D3D3DhcGJIoevlUygipAuhpEXZzGQU5U7U7U7U7U7oOIlMbkRcRD1zCnkpQtb3e3Kc8M7U7U7U7UxXefeahfDiQwCXmqoUnQtDE6mqv3C3D3D3D3D3DhuXfZaLvH1U6mUgLh1jyyq9gabGgdfhRjk4OnWagWbtWHw8cRzaXlaCGrbohfDiQwCXmqjcV5U7U7U7U7vmrbbWrrhIQfxmdKJBJ68GxNbQ6M7U7U7U7U7U7GkUygOSkS2vNX1O8OobddQ3aia0yO4ynrbhTbgWagW4re8cRzaXlaCGrbohfDiQwCXmqjcV5U7U7U7U7vmrzU7U7U7U7U7UdQ4IzGYQWAxDgxJYJ6emmOEdGaqJHIJ1efC0gyaJA8icWs9wAgq8cahyuGZrrhIQfxmduIWBU7U7U7U7E1dm3D3D3D3D3C3D3D3D3D8HrcRyGssqMHgRaav9asWxSWy9ugguVHh1XhgjSIbkjbzgAScau1dibFXcJ1tzyq9goqa5uqBHh4OwNcqa5emmOEdGaqJHIJ1eLMr0uZis0rV3mckW5DoufCoOIlMbkRcRD1zCnk4CgeQcdS0X0yjcV5U7U7Ux9aZD39QhyU7UBU7UJvSWyDhFyKWkgOKeKzOXkaqvpGe8flmwpLHb1BaV5vpajnjvaaarXqALN8Ylskw1aIUZpjyuiPSIkziPqDigzBAuGrCXQaKwXdjLRndIUtGWhjfQdXq4JKgqt2ombJgfcyIK2ombJgfsk6rVJMoedIlgQ54yq0DZXhgjSIbkjbzgAScau1dibBAcCujvZYJ64Xl14bETWl8MJpmsyfduscYm0yfaOQhqMvmxYcJpxO4YJ6nFKdV54dJewXaLKGmdnwbaQ6bKjqhIpxO4YJ6nFKdV54dJewXaLKGmdnwbaQ6bKGNdkiHIGGRr5rDgw4cEZXhgjSIbkjbzgAScau1dibphuqcfbbxJIpeQcZJ6uhEZXhgjSIbkjbzgAScau1dibFXcJ1tzyq9gEuNcf4ryiPaG6qeGq4JK2ombJgfsQ5MJKgqtIQii4AuiHqsdOjBhMGrJcjecdHHKsuXaYIgQZqs5tfzHKcfGKIpmsyfduscYm0yfaOQhGKgUZWGA0OWq4JK2ombJgfsQ5MJWqsJmqbmqiaJhTGhV4o4WDEcoCh35rlT0cViaqp1OgskddQrJcdHpskljyuiPTdtWOrHKgUxzxDgskxygnsAyIImChIHaMiPbHX4yq0DKuQZtK0k7QZqsblioMNqrqW1OqsRSRoJajf4TcwQaNTYh4GNe4TgbCoyPIeaty8jJevKHe4ODaVv(K4SvGHMiXh4Gh4rGK2ombJgfskGW92mi6U3ejCojCor4qv2vNbNtcNtcNtcNtcNtcNhueSm4enraNhueSw5qvW5KW5bfbd8CqbalMRbbCobyuXXqbW5KW5KW5COOd3zjAU7Uht3Ml27COkpQhueSw5qvoxpWjyyq9ga1GiCOMckcwRCOk4Cknd94YihhOdTNcCofkj60yEhkgEZD3Diaor4qv2vN5mqv3C3D3D3Ha4bfbldorteoxpWjyyq9gabaQh0uqrWYGt0ebCof0J7uhCT0c6PKOZavDZD3D3D3D3Ha4emmOEdGaa1dAIiCOk7QZGZPqgbSeGLb4us0zGQU5U7U7U7U7U7oeaVtZC8HrcRyGssqMHgRaav9aYeOdXNluCHRGIGLbNOjc05mqv3C3D3D3D3D3D3D3XhgjSIbkjbzgAScau1ditGoeFUqXfUckcwgCIMiqNh1XhgjSIbkjbzgAScau1dibBAcCujvZcEZD3D3D3D3D39kMOm3D3D3D3D3D3D39y62CXovZks0eeEuNdfD4oZPXCEH3C3D3D3D3D3D3D3XhgjSIbkjbzgAScau1ditGoeFUqXfUckcwgCIMiqNh1XhgjSIbkjbzgAScau1ditGoeFUqXfUckcwgCIMiqNJENQzfjAcc4n3D3D3D3D3D3D3Diao(WiHvmqjjiZqJvaGQEazc0H4ZfkUWvqrWYGt0eb6CCRZRZavDZD3D3D3D3D3D3D3D3XhgjSIbkjbzgAScau1ditGoeFUqXfUckcwgCIMiqNh15fEZD3D3D3D3D3D3DV6bM7U7U7U7U7U7vpWC3D3D3D39QhyU7U7U7U7oeaNiCOk7QZ8OrDk4Sv0WNmc0a8iO4mqv3C3D3D3D3D3DhFyKWkgOKeKzOXkaqvpGmb6q85cfx4kOiyzWjAIaDEuVdfdV5U7U7U7U7vpWC3D3D3REG5U7U7UdbWjaJkogkW56bobyuXXqbE0OoETG74rD8CgOQBU7U7U7U7oeaNiCOk7QZ8OrDkPzb8ifjsy4e8WiHLvwrcnapckodu1n3D3D3D3D3D3zCHIlGG6efgRj8HrcRyGssqMHgRaav9aYSI5swy85cfxW5nFNdvbNNPy8HqvnLiAp15jCEqrWYGt0erKNi8M7U7U7U7U7U7yflmw3zyHl4n3D3D3D3DV6bM7U7U7U7UdbWjchQYU6mpAuNsAwapsrIegobpmsWd8eOc0oGhbfNbQ6M7U7U7U7U7U7aOX8ilCz7qDhm4GWiAcFyKWkgOKeKzOXkaqvpGmRyUKfgFUqXvIEaT5U7U7U7U7U7U7UdbWZgx4HopAuVZHQCgOQBU7U7U7U7U7U7U7U7oeahFyKWkgOKeKzOXkaqvpGe8CqbjueeCnkNbQ6M7U7U7U7U7U7U7U7U7U7X0T5IDgeQclsfaMh1ZgxGdDo69mfJpeQQPeH3C3D3D3D3D3D3D3D3D3DhcGZGqvyrQaWCCdhFyKWkgOKeKzOXkaqvpGe8CqbjueeCnk(qOkmNbQ6M7U7U7U7U7U7U7U7U7U7U7EA1daliowcfbbxJQjcgguVbqaOXqXXAIsZi8yOqfwf4CmVzaHhackW5DoufCodcvHfPcalr4CkGhgAIGsIWBU7U7U7U7U7U7U7U7U7Ux9aZD3D3D3D3D3D3D3D3D3DiaodcvHfPcaZXToVaHNZavDZD3D3D3D3D3D3D3D3D3D3DpT6bGfehlHIGGRr1ebddQ3aia0yO4ynrPzeEauf4bHXG6n8iGAuemkW5DouvIW5uapm0ebLeH3C3D3D3D3D3D3D3D3D3DV6bM7U7U7U7U7U7U7U7Ux9aZD3D3D3D3D3D3D3D3zCHIlGWku0zxnHpmsyfduscYm0yfaOQhqMvmxYcJpxO4copYMi8M7U7U7U7U7U7U7E1dm3D3D3D3D3D3REG5U7U7U7U7vpWC3D3D3REG5U7U7UdbWjchQYU6mpAuNcWBfSuboBLpWbpjWBnckodu1n3D3D3D3DhFyKWkgOKeKzOXkaqvpGmRyUKfgFUqXLh1B(ihEZD3D3D3D3XhgjSIbkjbzgAScau1ditGoeFUqXLh1B(ihEZD3D3D3D3XhgjSIbkjbzgAScau1dibFXcJ1tzyq9gEuNcf4n3D3D39QhyU7Ux9aZREasA7WemAuKSKGrHKwzxDgsA7WemAuKGGckKugeQkaHHK2dJIpguJgfgbsR4HK2MoMgdHpsR4H0kVaH7GdpEIwTGwGJhuJN8I7TG0k1rawl82slTGxl4XtQboEYd0Ix8qaGEEsDegskOcQbigcWqlEWtEsn8axlOf4AbCTWtQrneaONA8ajnMMlaHpsAyIISxzxyiHqsBo6EHKs1kogaew5GfIXfuXiPvVnD4oRWGcqsXJhTqDK0Wefz1BthUZkmOaKqiPbqaaa1oCmljcFKucOEJ4cjfvsgiO2iPOchZGq4JKIkjdeuBeWeHHWqsX4Axi8rsrfoMbHWhHHWqszCXvNHWhjfv4ygecFegcdjnmrr2C09cbmrsXOJle(iPOchZGq4JWqyiPeqnxHWhjLaQ3iUqszrMQZsIKIkCmdcHpsklYuDwseWeHHWqyiPCbbqmi6oxmjddQrJcJaHpcdHHKsGKcoGWdiEbcp0cjnBKwXJAGdpegcc

--[[
Author : Aethys
Version : 1.2 (09.17.2015)
Readme :
	WeakAura to display each Soul timer + their HP.
]]--


--- Actions\On Init\Custom ---

-- Init
-- Initialization
WA_Aethys_Gorefiend_CSMaxHP = 1047180;
WA_Aethys_Gorefiend_PlayerTable = {};
WA_Aethys_Gorefiend_MobTable = {};
WA_Aethys_Gorefiend_RaidMessage = true;
WA_Aethys_Gorefiend_RaidMessageTimer = 3;
WA_Aethys_Gorefiend_ReturnString = "";


--- Trigger\Custom Trigger ---

-- Trigger [ENCOUNTER_END, COMBAT_LOG_EVENT_UNFILTERED]
function (_, _, subevent, _, _, _, _, _, destGUID, destName, _, destRaidFlags, spellid, _, _, amount)
    local name = destName and string.gsub(destName, "%-[^|]+", "") or nil;
    if subevent then
        if destGUID and string.find(destGUID, "-93288-") then
            if string.find(subevent, "_DAMAGE") then
                if not WA_Aethys_Gorefiend_MobTable[destGUID] then
                    WA_Aethys_Gorefiend_MobTable[destGUID] = WA_Aethys_Gorefiend_CSMaxHP;
                else
                    local HPLoss = amount or 0;
                    WA_Aethys_Gorefiend_MobTable[destGUID] = WA_Aethys_Gorefiend_MobTable[destGUID] - HPLoss;
                    if WA_Aethys_Gorefiend_MobTable[destGUID] < 0 then
                        WA_Aethys_Gorefiend_MobTable[destGUID] = 0;
                    end
                end
            end
            if subevent == "UNIT_DIED" then
                WA_Aethys_Gorefiend_MobTable[destGUID] = nil;
            end
        end
        if spellid and spellid == 189131 then
            if subevent == "SPELL_AURA_APPLIED" then
                table.insert(WA_Aethys_Gorefiend_PlayerTable, {name, GetTime()+35, destGUID});
                return true;
            end
            if subevent == "SPELL_AURA_REMOVED" then
                for k,v in pairs(WA_Aethys_Gorefiend_PlayerTable) do
                    if v[1] == name then
                        if WA_Aethys_Gorefiend_RaidMessage then
                            local timerLeft = v[2] - GetTime();
                            if timerLeft > WA_Aethys_Gorefiend_RaidMessageTimer then
                                SendChatMessage(string.format("%s libered at %.1fs", name, timerLeft), "RAID");
                            end
                            if timerLeft < 0.1 then
                                SendChatMessage(string.format("%s died during Digest", name), "RAID");
                            end
                        end
                        table.remove(WA_Aethys_Gorefiend_PlayerTable, k);
                    end
                end
            end
        end
        if subevent == "ENCOUNTER_END" then
            WA_Aethys_Gorefiend_PlayerTable = {};
            WA_Aethys_Gorefiend_MobTable = {};
            WA_Aethys_Gorefiend_ReturnString = "";
        end
    end
end


--- Display\Custom Function ---

-- Refresh [Every Frame]
function()
    WA_Aethys_Gorefiend_ReturnString = "                                                               ";
    
    for k,v in pairs(WA_Aethys_Gorefiend_PlayerTable) do
        if v[2] ~= nil then
            local name = v[1];
            local timer = string.format("%.1f", v[2] - GetTime());
            local timerColor = "";
            local mobHealth = 101;
            if WA_Aethys_Gorefiend_MobTable[v[3]] ~= nil then mobHealth = WA_Aethys_Gorefiend_MobTable[v[3]]/WA_Aethys_Gorefiend_CSMaxHP*100; end
            
            -- Timer & Name Color
            if tonumber(timer) >= 10 then
                timerColor = "|cFFEB260A" .. timer .. "|r";
                name = "|cFFEB260A" .. name .. "|r";
            else
                timerColor = "|cFF47DC38" .. timer .. "|r";
                name = "|cFF47DC38" .. name .. "|r";
            end
            -- Health Percentage Color
            if mobHealth == 101 then
                healthPercentage = "??";
            elseif mobHealth <= 35 then
                healthPercentage = string.format("|cFFEB260A%.0f|r", mobHealth);
            elseif mobHealth <= 70 then
                healthPercentage = string.format("|cFFFF7D0A%.0f|r", mobHealth);
            else
                healthPercentage = string.format("|cFF47DC38%.0f|r", mobHealth);
            end
            
            WA_Aethys_Gorefiend_ReturnString = WA_Aethys_Gorefiend_ReturnString .. "\124n".. string.format("%s(%s) - %s", name, healthPercentage, timerColor);
        end
    end
    
    return WA_Aethys_Gorefiend_ReturnString;
end