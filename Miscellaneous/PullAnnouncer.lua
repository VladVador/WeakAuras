--- WeakAura Strings ---
dGuItaGik6ssfuJsaNIQ0RKkaZIs6wQu7sf)sQa1WOk6ykfzzOc9mPImnLI6AcvABsfsFdvGoNuH4DufUhQQ9jvqoOQYcfLEOumrPsxuQAJkL(iQOrkvuNuu0kfPzkQCtHYorv(jQ0qfrlLs0tf0ufYvrf0wrfWxPe4Scv9wPcK7kvaTxe9xk1GjhgLflQ6XQQMmfUSKnlcFwGgTs1PvLxtj0SPQUTuA3i9BLmCrHLRWZv00PY1ry7QKVtjOXlvOoVsH5luX(Hj3ezezylzObzObzezOXBMHpBJOQJDKHKHm6)(AKC9OoYWC9BJidF0NZ(F1MHF5kdsEBImK97El6KmIm8rFoYiYqJL9pX0TAjZsg(tmDRwYW77BKEFdXHZAaXbyJhlVFnHce)IaANDvqUfuh8O8xmdiwcxnGAxgVeVFM7TOtVi9((gPmIbZUOxNMDgLw(q8HmZXT5lNPhq33qCjCzq4GA2zuA5JuiiiO7BOKeoiZCCB(Yzc5wqgVzg(SnGC7fuBnNSGf0I6VbuI1aAJfb0Aa52lO)DgLw(qBSiGSqg1bf4I5tutO8L)Yc9Eqkeee09nKz4x8MwHm7JXnQ30kKz895YzAfYm5NLrXBAfYKtomZCDnTczYD72mB6T00kKPLFz210kKPLFz212c(SKxM8400kKzM8cJ(410B305ViZdsVVVr69nuZAuqCa24XY7xtOaD5cXJBeuexoSPZEr699nszedMDrVon71Vf3Ug5FggffIpucM)S8aPmIbZUOxNSR5m2Yi61wwHyedMDrVozxZzSLrp1i61wq8H80kKNEG077BKEFd1Sgf0wc6V7TOtOaD5cXJBeuexoSPZEr699nsVVH2sq)DVffYTGMf1aYTxqT1CYcwqmQbugJ6QOoOeed3EnG(3RFlEqAcc6V7TOqmIbZUOxNy1CYcwqbIvZjly5fPqqqqVeqmIbZUOxNMDgLw(q85dzMJBZxoti3Errkeeeeeee0lbeJyWSl61j7AoJTmIETfeIdFipHwdigXGzx0Rt21CgBz0tnIET1nNLl61wb8c1H4d5jKBVOifccccccccccckJXJ6ceRMtwW6CmHyoiZZz6gpAWtI1OL5cy2H98WXeMwHyedMDrVozxZzSLrp1i61w3CwUOxBfWR3ZXCEm96bsHGGGGGGGk)zHuiiiiiiiiiiiOmgpQlqSAozbRZX8y61dKcbbbbbbbvudKcbbbv(Z6LaIrmy2f960SZO0YhIpFiZWV4nHwdigXGzx0RtZoJslFi(8Hm7JXnQ3eAnGyedMDrVon7mkT8H4ZhYm((C5mHwdigXGzx0RtZoJslFi(8Hmt(zzu8MqRbeJyWSl61PzNrPLpeF(qMCYHzMRRj0AaXigm7IEDA2zuA5dXNpKj3TBZSP3stO1aIrmy2f960SZO0YhIpFitl)YSRj0AaXigm7IEDA2zuA5dXNpKPLFz212c(SKxM840eAnGyedMDrVon7mkT8H4ZhYmtEHrF8A6TB68xKjKBVOifccccccc6LaIrmy2f96KDnNXwgrV2ccXHpKNqRbeJyWSl61j7AoJTm6PgrV26MZYf9ARaEH6q8H8eYTxuKcbbbbbbbbbbbfwuJMDMlwnNSGvGy1CYcwNJjeZbzEot34rdEsSgTmxaZoSNhoMW0keJyWSl61j7AoJTm6PgrV26MZYf9ARaE9EoMZJPvigXGzx0RtZoJslFVEGuiiiiiiiOYFwifccccccccccckSOgn7mxSAozbRaXQ5KfSohZJPvigXGzx0RtZoJslFVEGuiiiiiiiOIAGuiiiOYFwifccccccckJXJ6cy2bzbF2jj89)O0fXFn6aHSGXIge6FNrPLp0SCqpkKBVGYK(CqH1V7TOhtVifcccQOgifcccIrmy2f960Sx)wC7AK)zyuui(qUbr5bsHGGGgLJyq9aPf1G0r6idDJxWG1GmIm0Trgfz4pX0TAjdnigm3Brjd3ez4pX0TAjdtqq)DVffkq)vrDwHsoQeVo2kuZQnpZ1FvuNviBRq2wHcxeJ)IhRTScfUig)1wFwWPviBRq2wH6wthpwBzfQBnDB9zbNwHSTczBfkmJY3NhRT8IuiiiO7BOSR5ek2YakjHVpu0RTgqDMrn8RbsHGGGEjG6VkQdIpFiZMo)fzhlKt7VUD5YZeIrnGsoQeVogIpFiZUB2eIrnGMUXJg8K4rnc0SAZZC9xf1zfYmzKPxi3ErrkeeeeeeeeJyWSl61j7AoJTmIETfeFi3Is0MVgbMUXJg8mjYhOz1MN56VkQZk0MTcfxVE9aPqqqqqqqqmIbZUOxNSR5m2YONAe9Ali(qCwUOxBfWluhaeJyWSl61j7AoJTmIETLhifcccQOgifccc6(gk5OUkQdkbXWTxdOM963ItKcbbb9sa1FvuheF(qMjZ9fFVL2w2Zzpp7EEFzZ131eYTxuKcbbbbbbbXigm7IEDA2RFlUDnY)mmkkeFOem)z5bsHGGGkQbsHGGGUVHss47d1Sx)weQZmQHFnqkeee0lbeD5GyedMDrVon71Vf3Ug5FggffIrnG6wthpwBbXOgqHlIXFXJ1wqmQbu3A64XAlieh(qHlIXFXJ1wqmQbeD5GMUXJg8K4rnc0SAZZC9xf1zfYmzVLzYTBMnMEHyudOat34rdEs8OgbAwT5zU(RI6SczA39l2hN9MEHwdOPB8ObpjEuJanR28mx)vrDwHmTJLzyyFxtVEHC7ffPqqqqqqqq33qj9zBudOpNJ9BrKcbbbbbbb9saL)5o5zuJaHlIXFT1NfCAfQHBSSFr54YPn3SP9nr2rXNS3ozUV47T0leIdFipHyudO8p3jpJAeOBnDB9zbNwHA4gl7xuoUCAZnBAFtKDu8j7T5LSXleIdFipHC7ffPqqqqqqqqqqqqVeqt34rdEs8OgbAwT5zU(RI6SczgAbzYJttVqU9IIuiiiiiiiiiiiiiiiigXGzx0RtSAozbRaHlIXFXJ1wNJjuge((LbK550TMoES26CmHSWNBh6JWTG(Co2Vfn96bsHGGGGGGGGGGGGGGGgLJyq9aPqqqqqqqqqqqqL)SqkeeeeeeeeeeeeeeeeJyWSl61jwnNSGvGWfX4V4XARZXekdcF)YaY8C6wthpwBDoMqw4ZTdzEoHzu((8yTLxpqkeeeeeeeeeeeeeee0OCedQhifcccccccccccQOgifccccccc6(gk7YydOKe((ifcccccccQ8N1lbu(N7KNrnc0TMUT(SGtRqnCJL9lkhxoT5MnTVjYok(K92jZ9fFVLEHqC4d5jeJAaL)5o5zuJaHlIXFT1NfCAfQHBSSFr54YPn3SP9nr2rXNS3MxYgVqio8H8eYTxuKcbbbbbbbbbbbXigm7IEDIvZjlyfOBnD8yT15ycLFzSbuge((LbK55eUig)fpwB51dKcbbbbbbbbbbbnkhXG6bsHGGGGGGGUVHswoOpNJ9BrKcbbbbbbbv(Z6Lak)ZDYZOgbcxeJ)ARpl40kud3yz)IYXLtBUzt7BISB4YlYsU5StM7l(El9cH4WhYtig1ak)ZDYZOgb6wt3wFwWPvOgUXY(fLJlN2CZM23ezhfFYEBEjB8cH4WhYti3ErrkeeeeeeeeeeeeJyWSl61jwnNSGvGWfX4V4XARZXmqYY5fkdcF)YaY8C6wthpwB51dKcbbbbbbbbbbbnkhXG6bsHGGGGGGGUVHswoOSlJnGss47JuiiiiiiiOYFwVeq5FUtEg1iq4Iy8xB9zbNwHA4gl7xuoUCAZnBAFtKDdxErwYnNDYCFX3BPxieh(qEcXOgq5FUtEg1iq4Iy8xB9zbNwHA4gl7xuoUCAZnBAFtKDu8j7T5LSXleIdFipHC7ffPqqqqqqqqqqqqmIbZUOxNy1CYcwb6wthpwBDoMbswoVq5xgBaLbHVFzazEoHlIXFXJ1wE9aPqqqqqqqqqqqqJYrmOEGuiiiiiiiOIAGuiiiOIAG0IAqg(tmDRwB3gzuKH1vrDKH)71VfjdRRI6idRRI6MKHnCJL9lYohxoT75a98IS5qEBZmxuVL9DTcLm3x89wABzpN98S759LnxFxRqnD(lYowiN2FD7YLhz4pX0TAT3FgfzO71wgKoYWrf8TOrBKrrg6Qo2rgMyWARq3G5yK84izOf(mC7KB3CC9StD0o1Pnhxp5yN4GDK4YrYe3XLJKHZYprY1J6idZ1VnImKs0gnEbdwJjjVnrg(midTGp7VYTVX0ojHV)hLUiO)1GmCVEb3DKB3CC9StD0o1Pnhxp5yN4GDK4YrYe3XLJKH(lMbzezOXlrI3pHVBdYiYWwcF3JmI0r6idhl)ImImSLW39iJiDKoYWeSF3BrjJidBj8DpYishPJm0X8lQJmImSLW39iJiDKoYWb7ViJidBj8DpYishPJ0r6idNKHC8SPJNhoYbjdVi5TPnZXnr6ijb


--[[
Author : Aethys
Version : 1.0 (06.18.2016)
Readme :
    WeakAura that send a chat message to show who pulled and how far from the Pull Timer if there is one.
    You can customize the channel output in the init section.
    I recommend you to set a limiter in the load tab to only load the WA in raid or whenever you want, it may be annoying in solo.
]]--


--- Actions\On Init\Custom ---

-- Init
---
-- User Variables (You have to /reload after modifications)
---
aura_env.Channel = "LOCAL"; -- Output Channel
	-- Put "LOCAL" to display the message only for you or the channel you want (values below).
	-- "SAY", "EMOTE", "YELL", "PARTY", "GUILD", "OFFICER", "RAID", "RAID_WARNING", "INSTANCE_CHAT".
---
-- Core Variables (DO NOT TOUCH)
---
aura_env.CheckForbidden = false;
aura_env.BossModTime, aura_env.BossModEndTime = 0, 0;
---
-- Core Functions (DO NOT TOUCH)
---
-- Function to send the message and prevent further check.
function aura_env.Message (Message)
	if aura_env.Channel == "LOCAL" then
		if aura_env.BossModTime ~= 0 or aura_env.BossModEndTime-GetTime() >= 0 then
			print(Message.." at "..string.format("%0.2f", aura_env.BossModEndTime-GetTime()).."s.");
		else
			print(Message..".");
		end
	elseif aura_env.Channel == "SAY" or aura_env.Channel == "EMOTE" or aura_env.Channel == "YELL" or aura_env.Channel == "PARTY" or aura_env.Channel == "GUILD" or aura_env.Channel == "OFFICER" or aura_env.Channel == "RAID" or aura_env.Channel == "RAID_WARNING" or aura_env.Channel == "INSTANCE_CHAT" then
		if aura_env.BossModTime ~= 0 or aura_env.BossModEndTime-GetTime() >= 0 then
			SendChatMessage(Message.." at "..string.format("%0.2f", aura_env.BossModEndTime-GetTime()).."s.", aura_env.Channel);
		else
			SendChatMessage(Message..".", aura_env.Channel);
		end
	else
		print("[WA_PullAnnoucer] Wrong channel set in the Init Section.")
	end
	aura_env.CheckForbidden = true;
	return;
end


--- Trigger\Custom Trigger ---

-- Trigger [COMBAT_LOG_EVENT_UNFILTERED]

function (Event, Prefix, CombatEvent, _, _, SourceName, SourceFlags, _, _, DestName, DestFlags, _, _, SpellName)
	-- Boss Mod Pull Timer Handler
	if Event == "CHAT_MSG_ADDON" and Prefix == "D4" and string.find(CombatEvent, "PT") then
		aura_env.BossModTime = tonumber(string.sub(CombatEvent, 4, 5));
		aura_env.BossModEndTime = GetTime() + aura_env.BossModTime;
	end
	-- Prevent further Checks
	if Event == "PLAYER_REGEN_ENABLED" then
		aura_env.CheckForbidden = false;
	end
	-- Pull Check Handler
	if not aura_env.CheckForbidden and DestName and SourceName and DestName ~= SourceName and not string.find(CombatEvent, "PERIODIC") and (string.find(CombatEvent, "_DAMAGE") or string.find(CombatEvent, "_MISSED")) then
		-- Player Attack
		if bit.band(SourceFlags, COMBATLOG_OBJECT_TYPE_PLAYER) ~= 0 and bit.band(DestFlags, COMBATLOG_OBJECT_TYPE_NPC) ~= 0 then
			if string.find(CombatEvent, "SWING") then
				aura_env.Message(SourceName.." pulled "..DestName.." with Auto Attack");
				return;
			else
				aura_env.Message(SourceName.." pulled "..DestName.." with "..SpellName);
				return;
			end
		-- Body Pull
		elseif bit.band(DestFlags, COMBATLOG_OBJECT_TYPE_PLAYER) ~= 0 and bit.band(SourceFlags, COMBATLOG_OBJECT_TYPE_NPC) ~= 0 then
			aura_env.Message(DestName.." body pulled "..SourceName);
			return;
		-- Pet Attack
		elseif bit.band(SourceFlags, COMBATLOG_OBJECT_CONTROL_PLAYER) ~= 0 and bit.band(DestFlags, COMBATLOG_OBJECT_TYPE_NPC) ~= 0 then
			aura_env.Message(SourceName.."(Pet) pulled "..DestName);
			return;
		-- Pet Body Pull
		elseif bit.band(SourceFlags, COMBATLOG_OBJECT_CONTROL_PLAYER) ~= 0 and bit.band(SourceFlags, COMBATLOG_OBJECT_TYPE_NPC) ~= 0 then
			aura_env.Message(DestName.."(Pet) body pulled "..SourceName);
			return;
		end
	end
end