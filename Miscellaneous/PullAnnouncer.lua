--- WeakAura Strings ---
d0ubyaGiH6sQsqJsu5uIsVssrQzrGBrIDrs)svc1WKu6ykQSmQipJkW0uu11eu2MQK(gLGXPkL6CskQ3jkCpvX(uLqoiL0cvIEOcMOiCrL0gPc9rkrJKkOtkkALc8skHmtLWnfvTtH4NcPHkPAPur9uQQPkjxvvk2QKI4RQs0zvu8wfs3vHyVuL)ksdgDysTyfQhtOMmL6YsTzr0NfKrtqNwv9AfLMnv62kYUj63Qy4cQwUepxLMofxxP2oH8DkHA8QsjNxvQwVQeO3RkbmFjfUVKIK9d7nNxLN)KNVTNVTxLNV9)gUR(9Q(TmE(E(Lo0)iREp82Z30VLXZ)l)MuXNPWDBtB7fzopFTyZ)iVEvE(F534v55BFsfVVMZK3spFX7R5m55ROOGaffW3C7cynrx(6XU9fm3mNnOqTOg0CaFXL29OTb1jnDbC6y)t(fRn)J8MfbkkkiqVl60wksDqOwkBxWhW4frhSUiodqffWOBt4Bd4GqTu2UiaeeeurbS(2agVi6G1fXGMdO9)gUR(DqJWgCQVxDOg8iDFhm5Pa((zdEkGgHnOyHAPSDbF)SbTyT0aMtK2D3xWXT7XIZQIaqqqqffWyFRZelamEnF0Q1ybGXZSUyrSaW46wDUAMybGXw(MmxKiwayCuhDmZHvNJfag7S1mtelam2zRzMi9LwDosMrSmwayCMr8RSgzynDWHwRIvrGIIccuuahoLgSMOlF9y3(cMlruWirRaRI(MbhMfbkkkiqVl60wksDqylEwhpLXFB7wc(aMu7E7mqGEx0PTuK6YZ9M)yx9NAbG6DrN2srQlp3B(J9Q0U6p1GpG1kaS2mqGEx0PTuKQF4TR7f8b8fabGGGGkkGv6T0GaqqqWrDqyHnc4dOPSBbGkkGVuxk)tbubSsVLgeaccco6RonNtZpc4dOPSBbGkkG11UA7Veub05w8Sh5xgcbGGGGJ6uTwWbVoc4dOPSBbGkkGoClnDbubmX)AkAXMVmeOVWJbbGGGGJg2Ro5KtJa(aAk7waOIcyclcubmHUml4WzAslTraiii4OZnxyHn)RJa(aAk7waOIcy(JCwqfW6LJOZSncabbbh9vluZHnc4dOPSBbGkkGjk7VnOcOLLJf7IaqqqWrN7TdZP5dBeWhqtz3cavuat4qqfWQtzQLgeacccQOa6)DBP4(fNP00LYoCdcabbbh91WcZPraFanLDlaurb8L6s5FkGkG13ttTlcabbbhTMF1jhm3iGpGMYUfaQOawx7QT)sqfqN7X7zBeaccco6CZBbh8QtJa(aAk7waOIcOd3stxavahoBPPlG(cpgeaccco6Cw41xhb8b0u2TaqffqNpH2nOcOf9fplcabbbhDElmVfEDeWhqtz3cavuatyrGkG(MIwgA7QnncabbbhDEleMtV9iGpGMYUfaQOaMWIavaZ)L2jlD)c2iaeeeC05EBhyHWCAeWhqtz3cavuat4qqfWHJ8UNAW86qFXiaeeeurbmrpENmjcabbbhD(WcZP5hb8b0u2TaqffWeweOc4Gq9xEbpjbZuCJaqqqWrNVMdZcVoc4dOPSBbGkkGjSiqfWeT2ie0YYpCeacccoQfSWR1(6iGpGMYUbvuatyrGkGj0Lzb9)tBxT4YEcb1uzGafffeOOaoCknOJBPyZ)iVG5sefms0kWQOVzWHzrGIIccuuaDClfB(hjO5aEBPnOrydo13RoudQL2GHxArT0aMCxmc7cOyHT4zvrqYTuS5FKG6DrN2srQ577vhQbZLVVxDOolcabbb)jb17IoTLIuheQLY2f85bmEr0bRlIbncBjcabbbbbbb)jb17IoTLIuxEU38h7Q)udIA8awlOwAdQ3fDAlfPU8CV5p2Rs7Q)uRyzBQ(tDUSGVOhqL5ancBjcabbbbbbbbbbbdV8LMC577vhQvvJb1gWyv1RP8LHutEktAtU4xyTQoLmwaOEx0PTuK6YZ9M)yVkTR(tTILTP6p15YMvvn(QgNndeaccccccc2U3gbGGGGGGGGGGGGHx(stU899Qd1QQXQXzZabGGGGGGGGT0gbGGGGT7T)jb17IoTLIuheQLY2f85bm236mXGNcOEx0PTuK6GqTu2UGppGXR5JwTgdEkG6DrN2srQdc1sz7c(8agpZ6IfXGNcOEx0PTuK6GqTu2UGppGX1T6C1mXGNcOEx0PTuK6GqTu2UGppGXw(MmxKig8ua17IoTLIuheQLY2f85bmoQJoM5WQZXGNcOEx0PTuK6GqTu2UGppGXoBnZeXGNcOEx0PTuK6GqTu2UGppGXoBnZePV0QZrYmILXGNcOEx0PTuK6GqTu2UGppGXzgXVYAKH10bhATkg0iSLiaeeeeeee8NeuVl60wksD55EZFSR(tniQXdyTGAPnOEx0PTuK6YZ9M)yVkTR(tTILTP6p15Yc(IEavMd0iSLiaeeeeeeeeeee0VL2dc1M899Qd15Y33RouRQgdQnGXQQxt5ldPM8uM0MCXVWAvDkzSaq9UOtBPi1LN7n)XEvAx9NAflBt1FQZLnRQA8vnwaOEx0PTuK6GqTu2UzZabGGGGGGGGT7TraiiiiiiiiiiiOFlTheQn577vhQZLVVxDOwvnwnwaOEx0PTuK6GqTu2UzZabGGGGGGGGT0gbGGGGT7Traiiiiiiiy4LV0KlE0xAnT(211QuE2I7YiGVSCKHaflulLTl4TnGFjOrydMP8Ba9BXM)rQgNfbGGGGT0gbGGGG6DrN2srQdcBXZ64Pm(BB3sWhqtz3zGaqqqWsB2fzgiOL2EgpJN)TDtw)8Lgp)fRow55RTT)M)rQDtnLFOqD56v5z881sXcpL6NV045Vy1Xkp)Kf9u7BkAJ2lItE(w832i0ZX5dRwh8QdCW8HvRtoWc1Cyo5LujmN88nLFOqDXRYZ38E4TNV491CM88fVVMZuQ59WBp)wulnE(27I28psp)588flSfpRNFlQLgp)wulnxp)HO5xATkDrultxRjRrQsFtehZCr1QZRjeawFH1zwDo15vlxJKUgX6YfRjeao4qRvP59Tm1AIerJ45lEFnNjp)KBPyZ)ibZTkQLgbG1lDY)BjaC4mnwBwf1sJaWubGPca9p7I4oIEQfa6F2fXTJU6qxbGPcatfaMOVMi6PwayI(AC0vh6kamvaOF4TRBMjea6hE76grp1zraiiiOIc4YZ9cM)ydwF76cw9N6cOd1sB3UGaqqqWFsWvrT0a(8agp4qRvP59Tm1AIerJedQL2G1lDY)Bb(8agNy(yqT0g8AkFzi1KFPDUHZ0yTzvulncaJRxfNf0iSLiaeeeeeeeuVl60wksD55EZFSR(tn4dO5i3tJ7sURP8LHuV7X5gotJ1MvrT0iaCEbGHLnBgiaeeeeeeeuVl60wksD55EZFSxL2v)Pg8b0Y2u9N6CzbRPb17IoTLIuxEU38h7Q)uNbcabbbBPncabbbvuaRxArT0aMCxmc7c4GWw8Sxeaccc(tcUkQLgWNhW46lSoZQZPoVA5AK01iwxUynrmOrylraiiiiiiiOEx0PTuK6GWw8SoEkJ)22Te8bmP292zGaqqqWwAJaqqqqffW6BxxWbHT4zbDOwA72feaccc(tckpgq9UOtBPi1bHT4zD8ug)TTBjOwAdMOVMi6PgulTb9p7I4oIEQb1sBWe91erp1GOgpG(NDrChrp1GAPnO8yaVMYxgsn5xANB4mnwBwf1sJaW46RoNz0ezoeNfulTbZDnLVmKAYV0o3WzAS2SkQLgbGXPjSM3QLRXzbpfWRP8LHut(L25gotJ1MvrT0iamonFM((RjIZcEkGxt5ldPM8lTZnCMgRnRIAPray8Gv)Qu)3mmS67hNnlOrylraiiiiiiiOIcyDx97Db0QXOfplcabbbbbbb)jbh)nQJ1s7C(NDrC7ORo0va4q08lTwTiQLPrxgSouLwnt9106lSoZQZzbrnEaRfulTbh)nQJ1s7Cj6RXrxDORaWHO5xATArultJUmyDOkTAM6RPrQpKfe14bSwqJWwIaqqqqqqqqqqqWFsWRP8LHut(L25gotJ1MvrT0iam2)LzgXY4SGgHTebGGGGGGGGGGGGGGGG6DrN2srQ577vhQZ5F2fXDe9uRQgdg(21TTbJvvt0xte9uRQgdAXFJqqRBZb0QXOfpBC2mqaiiiiiiiiiiiiiiiyPn7Imdeaccccccccccc2U3(NeuEmGxt5ldPM8lTZnCMgRnRIAPray8Gv)Qu)3mmS67hNf8ua17IoTLIu9dVDDVJ6hE76MzIrancBjcabbbbbbbbbbbbbbb17IoTLIuZ33RouNZ)SlI7i6Pwvngm8TRBBdgRQMOVMi6Pwvng0I)gHGXQQ(H3UUr0tD2mqaiiiiiiiiiiiiiiiyPn7Imdeaccccccccccc2sBeacccccccQOaU8y)oy9TRlcabbbbbbbB3B)tco(BuhRL25s0xJJU6qxbGdrZV0A1IOwMgDzW6qvA1m1xtRVW6mRoNfe14bSwqT0gC83OowlTZ5F2fXTJU6qxbGdrZV0A1IOwMgDzW6qvA1m1xtJuFiliQXdyTGgHTebGGGGGGGGGGGG6DrN2srQ577vhQZLOVMi6PwvngC8X(DWW3UUTnySQQ)zxe3r0tD2mqaiiiiiiiiiiiyPn7ImdeacccccccQOawVnGwngT4zraiiiiiiiy7E7FsWXFJ6yT0oN)zxe3o6QdDfaoen)sRvlIAzA0LbRdvPdrJu5C0fP1xyDMvNZcIA8awlOwAdo(BuhRL25s0xJJU6qxbGdrZV0A1IOwMgDzW6qvA1m1xtJuFiliQXdyTGgHTebGGGGGGGGGGGG6DrN2srQ577vhQZ5F2fXDe9uRQgNREBYcg(21TTbJvvt0xte9uNndeacccccccccccwAZUiZabGGGGGGGGkkG1Bd4YJ97G13UUiaeeeeeeeSDV9pj44VrDSwANZ)SlIBhD1HUcahIMFP1QfrTmn6YG1HQ0HOrQCo6I06lSoZQZzbrnEaRfulTbh)nQJ1s7C(NDrC7ORo0va4q08lTwTiQLPrxgSouLwnt910i1hYcIA8awlOrylraiiiiiiiiiiiOEx0PTuKA((E1H6Cj6RjIEQvvJZvVnzbhFSFhm8TRBBdgRQ6F2fXDe9uNndeacccccccccccwAZUiZabGGGGGGGGT0gbGGGGT0gbT02Zx8(AotPc)2TNV5p12EgpF5EQQ8dfQlxViZ55lS)HeA8CC(WQ1bV6ahmFy16KdSqnhMtEjvcZjpF3J22RYZ3(Nm5x8218UxLN)02189Q8mEgp)YXT9Q88N2UMVxLNXZ45B0UT04v55pTDnFVkpJNXZpPwS5FKEvE(tBxZ3RYZ4z88lAXTxLN)02189Q8mEgpJN)32Z)LwtT2gHVFtRVDDTkLNTuCx8mE(xpFNuNtTwvNSGNViViZnVtZ5z88a


--[[
Author : Aethys
Version : 1.0 (06.18.2016)
Readme :
    WeakAura that send a chat message to show who pulled and how far from the Pull Timer if there is one.
    You can customize the channel output in the init section.
    I recommend you to set a limiter in the load tab to only load the WA in raid or whenever you want, it may be annoying in solo.
]]--


--- Actions\On Init\Custom ---

-- Init
---
-- User Variables (You have to /reload after modifications)
---
aura_env.Channel = "LOCAL"; -- Output Channel
	-- Put "LOCAL" to display the message only for you or the channel you want (values below).
	-- "SAY", "EMOTE", "YELL", "PARTY", "GUILD", "OFFICER", "RAID", "RAID_WARNING", "INSTANCE_CHAT".
---
-- Core Variables (DO NOT TOUCH)
---
aura_env.CheckForbidden = false;
aura_env.BossModTime, aura_env.BossModEndTime = 0, 0;
aura_env.Spells = {
	-- Taunt
	[355] = true, -- Warrior - Taunt
	[62124] = true, -- Paladin - Reckoning
	[20736] = true, -- Hunter - Distracting Shot
	[56222] = true, -- DK - Dark Command
	[115546] = true, -- Monk - Provoke
	[6795] = true, -- Druid - Growl
	[185245] = true, -- DH - Torment
	-- Silence/Interrupt
	[6552] = true, -- Warrior - Pummel
	[96231] = true, -- Paladin - Rebuke
	[147362] = true, -- Hunter - Counter Shot
	[1766] = true, -- Rogue - Kick
	[47476] = true, -- DK - Strangulate
	[47528] = true, -- DK - Mindfreeze
	[183752] = true, -- DH - Consume Magic
	-- Debuff
	[45524] = true, -- DK - Chains of Ice
	[49576] = true, -- DK - Death Grip
	[77606] = true -- DK - Dark Simulacrum
};
---
-- Core Functions (DO NOT TOUCH)
---
-- Function to send the message and prevent further check.
function aura_env.Message (Message)
	if aura_env.Channel == "LOCAL" then
		if aura_env.BossModTime ~= 0 and aura_env.BossModEndTime-GetTime() >= -1 then
			print(Message.." at "..string.format("%0.2f", aura_env.BossModEndTime-GetTime()).."s.");
		else
			print(Message..".");
		end
	elseif aura_env.Channel == "SAY" or aura_env.Channel == "EMOTE" or aura_env.Channel == "YELL" or aura_env.Channel == "PARTY" or aura_env.Channel == "GUILD" or aura_env.Channel == "OFFICER" or aura_env.Channel == "RAID" or aura_env.Channel == "RAID_WARNING" or aura_env.Channel == "INSTANCE_CHAT" then
		if aura_env.BossModTime ~= 0 and aura_env.BossModEndTime-GetTime() >= -1 then
			SendChatMessage(Message.." at "..string.format("%0.2f", aura_env.BossModEndTime-GetTime()).."s.", aura_env.Channel);
		else
			SendChatMessage(Message..".", aura_env.Channel);
		end
	else
		print("[WA_PullAnnoucer] Wrong channel set in the Init Section.")
	end
	aura_env.CheckForbidden = true;
	return;
end


--- Trigger\Custom Trigger ---

-- Trigger [COMBAT_LOG_EVENT_UNFILTERED]

function (Event, Prefix, CombatEvent, _, _, SourceName, SourceFlags, _, _, DestName, DestFlags, _, SpellID, SpellName)
	-- Boss Mod Pull Timer Handler
	if Event == "CHAT_MSG_ADDON" and Prefix == "D4" and string.find(CombatEvent, "PT") then
		aura_env.BossModTime = tonumber(string.sub(CombatEvent, 4, 5));
		aura_env.BossModEndTime = GetTime() + aura_env.BossModTime;
	end
	-- Prevent further Checks
	if Event == "PLAYER_REGEN_ENABLED" then
		aura_env.CheckForbidden = false;
	end
	-- Pull Check Handler
	if not aura_env.CheckForbidden and DestName and SourceName and DestName ~= SourceName and not string.find(CombatEvent, "PERIODIC") and (string.find(CombatEvent, "_DAMAGE") or string.find(CombatEvent, "_MISSED") or string.find(CombatEvent, "CAST_SUCCESS")) then
		-- Player Attack
		if bit.band(SourceFlags, COMBATLOG_OBJECT_TYPE_PLAYER) ~= 0 and bit.band(DestFlags, COMBATLOG_OBJECT_TYPE_NPC) ~= 0 then
			if string.find(CombatEvent, "SWING") then
				aura_env.Message(SourceName.." pulled "..DestName.." with Auto Attack");
				return;
			elseif not string.find(CombatEvent, "CAST_SUCCESS") or aura_env.Spells[SpellID] then
				aura_env.Message(SourceName.." pulled "..DestName.." with "..SpellName);
				return;
			end
		-- Body Pull
		elseif bit.band(DestFlags, COMBATLOG_OBJECT_TYPE_PLAYER) ~= 0 and bit.band(SourceFlags, COMBATLOG_OBJECT_TYPE_NPC) ~= 0 then
			aura_env.Message(DestName.." body pulled "..SourceName);
			return;
		-- Pet Attack
		elseif bit.band(SourceFlags, COMBATLOG_OBJECT_CONTROL_PLAYER) ~= 0 and bit.band(DestFlags, COMBATLOG_OBJECT_TYPE_NPC) ~= 0 then
			aura_env.Message(SourceName.."(Pet) pulled "..DestName);
			return;
		-- Pet Body Pull
		elseif bit.band(SourceFlags, COMBATLOG_OBJECT_CONTROL_PLAYER) ~= 0 and bit.band(SourceFlags, COMBATLOG_OBJECT_TYPE_NPC) ~= 0 then
			aura_env.Message(DestName.."(Pet) body pulled "..SourceName);
			return;
		end
	end
end